# PLOV BOT — обзор и архитектура

PLOV BOT автоматизирует обработку музыкального релиза: собирает материалы у артиста, фиксирует юридические согласия, принимает оплату и формирует договор. Система рассчитана на работу в Telegram и интегрируется с внешними сервисами через вебхуки.

## Высокоуровневая архитектура

- **Telegram-бот (app/bot)** — конечная точка для пользователей. Построен на aiogram, использует FSM для пошагового сбора данных, хранит состояние в памяти процесса.
- **Веб-приложение (app/web)** — aiohttp-сервер, который принимает вебхуки провайдера платежей и технические запросы. Делит HTTP- и бот-трафик по отдельным обработчикам.
- **Сервисные модули** — обертки над платежным провайдером, генерацией договоров, файловым хранилищем и вспомогательными утилитами.
- **Слой данных** — асинхронный SQLAlchemy с Alembic-мigration workflow. Ответственен за модели, CRUD и подключение к БД.
- **Инфраструктура** — конфигурация через `.env`, единая настройка логов и запуск веб-сервера и бота из одного процесса (`app/main.py`).

### Последовательность основных действий

1. Пользователь запускает бота и проходит FSM: загружает трек и обложку, вводит метаданные релиза.
2. Бот предлагает текст согласия, фиксирует принятую версию и содержание.
3. По завершении анкеты создаётся платеж и пользователю отправляется ссылка на оплату.
4. Веб-приложение принимает уведомление провайдера, обновляет статус в БД и инициирует генерацию договора.
5. Договор сохраняется в файловом хранилище и отправляется пользователю, параллельно уведомляется администратор.

## Структура репозитория

- `app/` — исходный код приложения.
  - `bot/` — FSM-состояния, обработчики и клавиатуры Telegram-бота.
  - `web/` — aiohttp-приложение и эндпоинты вебхуков.
  - `payments/`, `contracts/`, `utils/` — интеграции и вспомогательные сервисы.
  - `database/` — модели, CRUD-слой и управление сессиями.
- `alembic/` и `alembic.ini` — миграции базы данных.
- `docs/` — эксплуатационная документация.

Дополнительные сведения: [INSTALL.md](INSTALL.md), [OPERATIONS.md](OPERATIONS.md), [DB.md](DB.md), [CONSENT.md](CONSENT.md), [CONTRACTS.md](CONTRACTS.md), [SECURITY.md](SECURITY.md).
